from diffusers import StableDiffusionPipeline
import torch
import os
from flask import Flask, request, send_file
from pyngrok import ngrok

app = Flask(__name__)

# ×ª×™×§×™×™×” ×œÖ¾Frames
FRAMES_DIR = "/content/frames"
os.makedirs(FRAMES_DIR, exist_ok=True)

# ×™×¦×™×¨×ª Pipeline ×©×œ Stable Diffusion
pipe = StableDiffusionPipeline.from_pretrained(
    "runwayml/stable-diffusion-v1-5",
    torch_dtype=torch.float16
)
pipe = pipe.to("cuda")  # GPU ×©×œ Colab

# ×¤×•× ×§×¦×™×” ×©××™×™×¦×¨×ª ×¤×¨×™×™××™× ×•×¡×¨×˜×•×Ÿ ×××™×ª×™ ×¢× ffmpeg
def generate_video_from_description(description, num_frames=5, fps=2):
    frame_paths = []
    for i in range(num_frames):
        image = pipe(description, guidance_scale=7.5).images[0]
        frame_path = os.path.join(FRAMES_DIR, f"frame_{i}.png")
        image.save(frame_path)
        frame_paths.append(frame_path)
        print("âœ… Saved frame:", frame_path)

    # ×™×¦×™×¨×ª ×•×™×“××• ×××™×ª×™ ×¢× ffmpeg
    video_path = os.path.join(FRAMES_DIR, "video.mp4")
    ffmpeg_cmd = f"ffmpeg -r {fps} -i {FRAMES_DIR}/frame_%d.png -vcodec libx264 -pix_fmt yuv420p {video_path} -y"
    os.system(ffmpeg_cmd)
    print("ğŸ¬ Video saved at:", video_path)

    return video_path

# Flask endpoints
@app.route("/generate", methods=["POST"])
def generate():
    data = request.json
    description = data.get("description")
    if not description:
        return {"error": "No description provided"}, 400

    video_path = generate_video_from_description(description, num_frames=15, fps=2)
    return {"video_url": f"https://7c4232e5b5b8.ngrok-free.app/video"}  # URL ×™×©×™×¨ ×œ×¡×¨×˜×•×Ÿ
    print("Files in frames dir:", os.listdir(FRAMES_DIR))

@app.route("/video")
def get_video():
    return send_file(os.path.join(FRAMES_DIR, "video.mp4"), mimetype="video/mp4")

# ×¤×•×ª×—×™× × ×’×™×©×•×ª ×—×™×¦×•× ×™×ª ×¢× ngrok
public_url = ngrok.connect(5000)
print("Public URL:", public_url)

app.run(host="0.0.0.0", port=5000)
